#!/bin/bash
set -euo pipefail

# Set global RUSTFLAGS to suppress warnings
export RUSTFLAGS="-Awarnings"

QUICK=false

CARGO_BUILD_PROFILE="--release"
CARGO_INSTALL_PROFILE=""
CARGO_BUILD_SUBDIR="release"
# Check for --dev flag
for arg in "$@"; do
  if [[ "$arg" == "--quick" ]]; then
    QUICK=true
    CARGO_BUILD_PROFILE=""
    CARGO_INSTALL_PROFILE="--debug"
    CARGO_BUILD_SUBDIR="debug"
  fi
done

printf "Initializing Git submodules...\n"
git submodule update --init --recursive
printf "Done\n"

printf "Installing Abra CLI to Cargo bin...\n"
cargo build $CARGO_BUILD_PROFILE
cargo install $CARGO_INSTALL_PROFILE --bin abra --path abra_cli || {
  printf "Failed!\n"
  echo "Failed to install Abra CLI. Please check your Rust installation." >&2
  exit 1
}
printf "Done\n"

printf "Installing Abra modules...\n"
if [ -d $HOME/.abra/abra ]; then
    mv "$HOME/.abra/abra" $HOME/.abra/abra_to_delete
    rm -rf $HOME/.abra/abra_to_delete &
fi
mkdir -p $HOME/.abra/abra
cp ./Cargo.toml $HOME/.abra/abra/Cargo.toml
cp -R ./modules $HOME/.abra/abra/
mkdir -p $HOME/.abra/abra/target/$CARGO_BUILD_SUBDIR
cp -R ./target/$CARGO_BUILD_SUBDIR/lib* $HOME/.abra/abra/target/$CARGO_BUILD_SUBDIR
printf "Done\n"

install_vim_syntax_highlighting() {
VIM_DIR="$HOME/.vim"
if [ -d "$VIM_DIR" ]; then
  printf "Installing Vim syntax highlighting... "
  mkdir -p "$VIM_DIR/syntax"
  mkdir -p "$VIM_DIR/ftdetect"
  cp ./tooling/vim/syntax.vim "$VIM_DIR/syntax/abra.vim"
  cp ./tooling/vim/ftdetect.vim "$VIM_DIR/ftdetect/abra.vim"
  printf "Done\n"
else
  echo "Vim configuration directory not found. Skipping Vim syntax highlighting installation."
fi
}

install_abra_vscode_extension() {
  if ! command -v code &> /dev/null; then
    echo "VS Code ('code' command) not found. Skipping Abra VS Code extension installation."
    return
  fi

  printf "Installing Abra VS Code extension...\n"

  if ! command -v npm &> /dev/null; then
    echo "'npm' not found. Please install Node.js and npm to proceed." >&2
    return 1
  fi

  if ! command -v vsce &> /dev/null; then
    printf "  - Installing 'vsce' tool... "
    npm install -g @vscode/vsce --quiet || {
      printf "Failed!\n"
      echo "Failed to install 'vsce'. Please check your npm setup." >&2
      return 1
    }
    printf "Done\n"
  fi

  pushd tooling/vscode > /dev/null
  printf "  - Packaging VS Code extension... "
  if vsce package --allow-missing-repository > /dev/null 2>&1; then
    printf "Done\n"
  else
    printf "Failed!\n"
    echo "Failed to package the VS Code extension. Please check the 'vsce' setup." >&2
    popd > /dev/null
    return 1
  fi

  printf "  - Installing extension... "
  if code --install-extension abra-0.0.1.vsix --force > /dev/null 2>&1; then
    printf "Done\n"
  else
    printf "Failed!\n"
    echo "Failed to install the Abra VS Code extension. Please check VS Code permissions." >&2
    popd > /dev/null
    return 1
  fi

  popd > /dev/null
}

if [ $QUICK = false ]; then
    install_vim_syntax_highlighting
    install_abra_vscode_extension
fi

printf "\nSetup complete! Abra is ready to use."
echo " To get started:"
echo "- Run \`abra --help\` to see available options."
echo "- Create a new Abra program and run it with \`abra <filename>.abra\`."

