#!/bin/bash
set -euo pipefail

# Set global RUSTFLAGS to suppress warnings
export RUSTFLAGS="-Awarnings"

printf "Initializing Git submodules... "
git submodule update --init --recursive
printf "Done\n"

CURRENT_COMMIT=$(git rev-parse HEAD)
printf "Installing Abra CLI to Cargo bin... "
printf "Installing Abra modules... "
if [ -d $HOME/.abra/abra ]; then
    mv "$HOME/.abra/abra" $HOME/.abra/abra_to_delete
    rm -rf $HOME/.abra/abra_to_delete &
fi
cp -R . $HOME/.abra/abra
pushd $HOME/.abra/abra
git checkout $CURRENT_COMMIT
cargo build --release
cargo install --bin abra --path abra_cli || {
  printf "Failed!\n"
  echo "Failed to install Abra CLI. Please check your Rust installation." >&2
  exit 1
}
popd
printf "Done\n"

VIM_DIR="$HOME/.vim"
if [ -d "$VIM_DIR" ]; then
  printf "Installing Vim syntax highlighting... "
  mkdir -p "$VIM_DIR/syntax"
  mkdir -p "$VIM_DIR/ftdetect"
  cp ./tooling/vim/syntax.vim "$VIM_DIR/syntax/abra.vim"
  cp ./tooling/vim/ftdetect.vim "$VIM_DIR/ftdetect/abra.vim"
  printf "Done\n"
else
  echo "Vim configuration directory not found. Skipping Vim syntax highlighting installation."
fi

install_abra_vscode_extension() {
  if ! command -v code &> /dev/null; then
    echo "VS Code ('code' command) not found. Skipping Abra VS Code extension installation."
    return
  fi

  printf "Installing Abra VS Code extension...\n"

  if ! command -v npm &> /dev/null; then
    echo "'npm' not found. Please install Node.js and npm to proceed." >&2
    return 1
  fi

  if ! command -v vsce &> /dev/null; then
    printf "  - Installing 'vsce' tool... "
    npm install -g @vscode/vsce --quiet || {
      printf "Failed!\n"
      echo "Failed to install 'vsce'. Please check your npm setup." >&2
      return 1
    }
    printf "Done\n"
  fi

  pushd tooling/vscode > /dev/null
  printf "  - Packaging VS Code extension... "
  if vsce package --allow-missing-repository > /dev/null 2>&1; then
    printf "Done\n"
  else
    printf "Failed!\n"
    echo "Failed to package the VS Code extension. Please check the 'vsce' setup." >&2
    popd > /dev/null
    return 1
  fi

  printf "  - Installing extension... "
  if code --install-extension abra-0.0.1.vsix --force > /dev/null 2>&1; then
    printf "Done\n"
  else
    printf "Failed!\n"
    echo "Failed to install the Abra VS Code extension. Please check VS Code permissions." >&2
    popd > /dev/null
    return 1
  fi

  popd > /dev/null
}

install_abra_vscode_extension

printf "\nSetup complete! Abra is ready to use."
echo " To get started:"
echo "- Run \`abra --help\` to see available options."
echo "- Create a new Abra program and run it with \`abra <filename>.abra\`."

